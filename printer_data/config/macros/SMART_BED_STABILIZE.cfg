[gcode_macro SMART_BED_STABILIZE]
description: Estabilizaci√≥n final optimizada para Phoenix LED
gcode:
    # 1. Par√°metros
    {% set TARGET_TEMP = params.TARGET|default(60)|float %}
    {% set TYPE = params.TYPE|default("NONE")|string|upper %}
    {% set CURRENT_BED_TEMP = printer.heater_bed.temperature %}
    {% set LED_NAME = "phoenix_led" %}
    
    # 2. Calentamiento inicial (Naranja Fuego)
    SET_LED LED={LED_NAME} RED=1.0 GREEN=0.3 BLUE=0.0
    M117 Calentando cama...
    SET_HEATER_TEMPERATURE HEATER=heater_bed TARGET={TARGET_TEMP}
    TEMPERATURE_WAIT SENSOR=heater_bed MINIMUM={TARGET_TEMP} MAXIMUM={TARGET_TEMP + 1}

    # 3. L√≥gica de selecci√≥n inteligente
    {% if CURRENT_BED_TEMP <= 40 %}
        
        # CATEGOR√çA: PLA (Prioridad por nombre o temperatura hasta 62¬∞C)
        {% if "PLA" in TYPE or (TYPE == "NONE" and TARGET_TEMP <= 62) %}
            {% set WAIT_TIME = 120 %}
            {% set MATERIAL = "PLA üçÉ" %}
            {% set R, G, B = 0.0, 1.0, 0.0 %} # Verde

        # CATEGOR√çA: TPU (Rango intermedio)
        {% elif "TPU" in TYPE or "FLEX" in TYPE or (TARGET_TEMP > 40 and TARGET_TEMP < 55) %}
            {% set WAIT_TIME = 180 %}
            {% set MATERIAL = "TPU ü§∏" %}
            {% set R, G, B = 0.6, 0.0, 1.0 %} # P√∫rpura

        # CATEGOR√çA: PETG (A partir de 65¬∞C si no se especifica nombre)
        {% elif "PETG" in TYPE or "PET" in TYPE or (TYPE == "NONE" and TARGET_TEMP >= 65 and TARGET_TEMP < 80) %}
            {% set WAIT_TIME = 300 %}
            {% set MATERIAL = "PETG ‚ôªÔ∏è" %}
            {% set R, G, B = 0.0, 0.5, 1.0 %} # Azul

        # CATEGOR√çA: ABS/ASA (T√©cnicos)
        {% elif "ABS" in TYPE or "ASA" in TYPE or (TYPE == "NONE" and TARGET_TEMP >= 80) %}
            {% set WAIT_TIME = 600 %}
            {% set MATERIAL = "T√©cnico üî•" %}
            {% set R, G, B = 1.0, 0.2, 0.0 %} # Naranja fuerte
        
        {% else %}
            {% set WAIT_TIME = 300 %}
            {% set MATERIAL = "Est√°ndar üõ†Ô∏è" %}
            {% set R, G, B = 0.8, 0.8, 0.8 %} # Blanco
        {% endif %}

        # Aplicar color y espera
        SET_LED LED={LED_NAME} RED={R} GREEN={G} BLUE={B}
        RESPOND MSG="Modo {MATERIAL} detectado. Estabilizando..."
        M117 {MATERIAL}: {WAIT_TIME // 60} min
        G4 P{WAIT_TIME * 1000}
        
    {% else %}
        {% set MATERIAL = "Re-impresi√≥n ‚ö°" %}
        SET_LED LED={LED_NAME} RED=0.0 GREEN=1.0 BLUE=0.5 # Cian
        RESPOND MSG="Cama caliente ({CURRENT_BED_TEMP}C). Saltando espera."
    {% endif %}

    # 4. Fin de estabilizaci√≥n (Luz Blanca suave)
    SET_LED LED={LED_NAME} RED=0.5 GREEN=0.5 BLUE=0.5
    M117 {MATERIAL} listo.
    RESPOND MSG="¬°Listo! Iniciando impresi√≥n."

